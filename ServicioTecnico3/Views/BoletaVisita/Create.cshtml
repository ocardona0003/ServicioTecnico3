@*Para controlar fechas*@
<link href="https://ajax.aspnetcdn.com/ajax/jquery.ui/1.12.1/themes/flick/jquery-ui.css" rel="stylesheet" />
<script src="https://ajax.aspnetcdn.com/ajax/jquery.ui/1.12.1/jquery-ui.min.js"></script>
@*Para controlar dropdownList con buscador*@
<link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>



@model ServicioTecnico3.Models.mostrar_Boleta_Visita_Tecnica_Enc_Result

@{
    ViewBag.Title = "Crear Boleta";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<br />
<br />


   
    @if (@ViewBag.MensajeLev != null && @ViewBag.TypeMensaje == false)
    {
        <div style="border: 1px thick;">
            <label class="alert-danger" style="padding: 5px;">@ViewBag.MensajeLev</label>
        </div>
    }
    else
    {
        <div style="border: 1px thick;">
            <label class="alert-success" style="padding: 5px;">@ViewBag.MensajeLev</label>
        </div>
    }



    <label style="font-size:medium;color:#3276B1">Encabezado</label>
    <div style="display:inline-block;text-align:center;float: right;">
        <a href='@Url.Action("Index","BoletaVisita")' class="btn btn-primary btn-icon-split">
            <span class="icon text-white-50">
                <i class="fas fa-backspace"></i>
            </span>
            <span class="text">Volver al Listado  </span>
        </a>
        <input type="submit" value="Guardar" class="btn btn-success btn-icon-split" />
    </div>
    <br />
    <br />
    <form id="frmEncabezado" action="">
        <fieldset>
            <div class="container-fluid ">
                <div class="row" style="padding: 2px">
                    <div class="col-xs-3 col-sm-3 col-md-2  col-lg-2 "><label for="ex3">Codigo de Boleta</label></div>
                    <div class="col-xs-3 col-sm-3 col-md-3  col-lg-3"><input id="codBoleta" type="text" name="codBoleta" value="@Model.codBoleta" tabindex="1" readonly="readonly" class="form-control"></div>
                    <div class="col-xs-3 col-sm-3 col-md-2  col-lg-2"><label for="ex3">Fecha Emisión</label></div>
                    <div class="col-xs-3 col-sm-3 col-md-3  col-lg-3"><input id="fechaEmision" type="text" name="fechaEmision" value="@Model.fechaEmision" tabindex="2" readonly="readonly" class="form-control"></div>
                </div>
                <div class="row" style="padding: 2px">
                    <div class="col-xs-3 col-sm-3 col-md-2  col-lg-2 "><label for="ex3">Fecha Visíta</label></div>
                    <div class="col-xs-3 col-sm-3 col-md-3  col-lg-3"><input id="fechaVisita" type="text" name="fechaVisita" value="@Model.fechaVisita" tabindex="3" class="form-control fecha"></div>
                    <div class="col-xs-3 col-sm-3 col-md-2  col-lg-2"><label for="ex3">Motivo Visita</label></div>
                    <div class="col-xs-3 col-sm-3 col-md-3  col-lg-3" tabindex="4">
                        <select id="motivoVisita" class="form-control dropdown-search" name="motivoVisita"></select>
                    </div>
                    @*<div class="col-xs-3 col-sm-3 col-md-3  col-lg-3"><input id="id" type="text" name="id" value="" tabindex="4" class="form-control"></div>*@
                </div>
                <div class="row" style="padding: 2px">
                    <div class="col-xs-3 col-sm-3 col-md-2  col-lg-2 "><label for="ex3">Técnico Visíta</label></div>
                    <div class="col-xs-3 col-sm-3 col-md-3  col-lg-3" tabindex="5">
                        <select id="usuarioVisitaNombre" class="form-control dropdown-search dropdown-usuarios" name="usuarioVisitaNombre"></select>
                    </div>
                    <div class="col-xs-3 col-sm-3 col-md-2  col-lg-2"><label for="ex3">Nit Cliente</label></div>
                    <div class="col-xs-3 col-sm-3 col-md-3  col-lg-3"><input id="nitCliente" type="text" name="nitCliente" value="@Model.nitCliente" tabindex="6" class="form-control"></div>
                </div>
                <div class="row" style="padding: 2px">
                    <div class="col-xs-3 col-sm-3 col-md-2  col-lg-2 "><label for="ex3">Nombre Cliente</label></div>
                    <div class="col-xs-3 col-sm-3 col-md-3  col-lg-3"><textarea id="nombreCliente" type="text" name="nombreCliente" value="@Model.nombreCliente" tabindex="7" class="form-control">@Model.nombreCliente</textarea></div>
                    <div class="col-xs-3 col-sm-3 col-md-2  col-lg-2"><label for="ex3">Direccion Cliente</label></div>
                    <div class="col-xs-3 col-sm-3 col-md-3  col-lg-3"><textarea id="direccionCliente" type="text" name="direccionCliente" value="@Model.direccionCliente" tabindex="8" class="form-control">@Model.direccionCliente</textarea></div>
                </div>
                <div class="row" style="padding: 2px">
                    <div class="col-xs-3 col-sm-3 col-md-2  col-lg-2 "><label for="ex3">Email Cliente</label></div>
                    <div class="col-xs-3 col-sm-3 col-md-3  col-lg-3"><input id="email" type="email" name="email" value="@Model.email" tabindex="9" class="form-control"></div>
                    <div class="col-xs-3 col-sm-3 col-md-2  col-lg-2"><label for="ex3">Resumen de Visíta</label></div>
                    <div class="col-xs-3 col-sm-3 col-md-3  col-lg-3"><textarea id="descripcionVisita" type="text" name="descripcionVisita" value="@Model.descripcionVisita" tabindex="10" class="form-control">@Model.descripcionVisita</textarea></div>
                </div>
                <div class="row" style="padding: 2px">
                    <div class="col-xs-3 col-sm-3 col-md-2  col-lg-2 "><label for="ex3">Estado</label></div>
                    <div class="col-xs-3 col-sm-3 col-md-3  col-lg-3" tabindex="11">
                        <select id="estado" class="form-control dropdown-search" name="estado"></select>
                    </div>
                    <div class="col-xs-3 col-sm-3 col-md-2  col-lg-2"><label for="ex3">Referencia O.T.</label></div>
                    <div class="col-xs-3 col-sm-3 col-md-3  col-lg-3"><input id="referencia1" type="text" name="referencia1" value="@Model.referencia1" tabindex="12" class="form-control"></div>
                </div>
            </div>
        </fieldset>
    </form>
<hr />


<div id="partialView-AddDetail" hidden="hidden">
    @{
        @Html.Action("_CreateDetail", "BoletaVisita", new { codBoleta = Model.codBoleta });
    }
</div>

<label style="font-size:medium;color:#3276B1">Listado de Tareas de Visita Técnica</label>
<div style="display:inline-block;text-align:center;float: right;">
    <a class="btn btn-primary btn-icon-split" onclick="MostrarNuevaTarea()">

        <span class="text">Agregar Tarea</span>
    </a>
</div>

<br />
<br />


<div id="partialView-getListDetail">
    @{
        @Html.Action("_GetListDetail", "BoletaVisita", new { codBoleta = Model.codBoleta });
    }
</div>

@*Para firma*@
<!-- Content -->
<div id="firmaCliente" class="container" >
    <div class="row">
        <div class="col-md-12">
            <label class="control-label">Firma de Aceptación del Cliente</label>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <canvas id="sig-canvas" width="620" height="160"></canvas>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <button class="btn btn-primary" id="sig-submitBtn">Capturar Firma</button>
            <button class="btn btn-default" id="sig-clearBtn">Limpiar Panel</button>
        </div>
    </div>
    <br />
    @*<div class="row">
            <div class="col-md-6">
                <textarea id="sig-dataUrl" class="form-control" rows="5">Data URL</textarea>
            </div>
        </div>
        <br />
        <div class="row">
            <div class="col-md-6">
                <img id="sig-image" src="" alt="Imagen de Firma en string" />
            </div>
        </div>*@
</div>
@*<div class="col-md-6">
        <button class="btn btn-primary" id="" onclick="disableScrolling()">Disable Scroll</button>
        <button class="btn btn-default" id="" onclick="enableScrolling()">Enable Scroll</button>
    </div>*@

<script src="~/Content/BoletaVisitaTecnica.js"></script>

<script>
    //variable de usuario que utilizo en el archivo
    var UserID = '@Session["UserID"]';


    //para firma
    (function () {
        window.requestAnimFrame = (function (callback) {
            return window.requestAnimationFrame ||
                window.webkitRequestAnimationFrame ||
                window.mozRequestAnimationFrame ||
                window.oRequestAnimationFrame ||
                window.msRequestAnimaitonFrame ||
                function (callback) {
                    window.setTimeout(callback, 1000 / 60);
                };
        })();

        var canvas = document.getElementById("sig-canvas");
        var ctx = canvas.getContext("2d");
        ctx.strokeStyle = "#222222";
        ctx.lineWidth = 4;

        var drawing = false;
        var mousePos = {
            x: 0,
            y: 0
        };
        var lastPos = mousePos;

        canvas.addEventListener("mousedown", function (e) {
            drawing = true;
            lastPos = getMousePos(canvas, e);
        }, false);

        canvas.addEventListener("mouseup", function (e) {
            drawing = false;
        }, false);

        canvas.addEventListener("mousemove", function (e) {
            mousePos = getMousePos(canvas, e);
        }, false);

        // Add touch event support for mobile
        canvas.addEventListener("touchstart", function (e) {

        }, false);

        canvas.addEventListener("touchmove", function (e) {
            var touch = e.touches[0];
            var me = new MouseEvent("mousemove", {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(me);
        }, false);

        canvas.addEventListener("touchstart", function (e) {
            mousePos = getTouchPos(canvas, e);
            var touch = e.touches[0];
            var me = new MouseEvent("mousedown", {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(me);
        }, false);

        canvas.addEventListener("touchend", function (e) {
            var me = new MouseEvent("mouseup", {});
            canvas.dispatchEvent(me);
        }, false);

        function getMousePos(canvasDom, mouseEvent) {
            var rect = canvasDom.getBoundingClientRect();
            return {
                x: mouseEvent.clientX - rect.left,
                y: mouseEvent.clientY - rect.top
            }
        }

        function getTouchPos(canvasDom, touchEvent) {
            var rect = canvasDom.getBoundingClientRect();
            return {
                x: touchEvent.touches[0].clientX - rect.left,
                y: touchEvent.touches[0].clientY - rect.top
            }
        }

        function renderCanvas() {
            if (drawing) {
                ctx.moveTo(lastPos.x, lastPos.y);
                ctx.lineTo(mousePos.x, mousePos.y);
                ctx.stroke();
                lastPos = mousePos;
            }
        }

        // Prevent scrolling when touching the canvas

        document.body.addEventListener("touchstart", function (e) {
            if (e.target == canvas) {
                disableScrolling();
                //e.preventDefault();
            } else {
                enableScrolling();
            }

        }, false);
        document.body.addEventListener("touchend", function (e) {
            if (e.target == canvas) {
                disableScrolling();
                //e.preventDefault();
            } else {
                enableScrolling();
            }
        }, false);
        document.body.addEventListener("touchmove", function (e) {
            if (e.target == canvas) {
                disableScrolling();
                //e.preventDefault();
            } else {
                enableScrolling();
            }
        }, false);

        (function drawLoop() {
            requestAnimFrame(drawLoop);
            renderCanvas();
        })();

        function clearCanvas() {
            canvas.width = canvas.width;
        }

        // Set up the UI
        var sigText = document.getElementById("sig-dataUrl");
        var sigImage = document.getElementById("sig-image");
        var clearBtn = document.getElementById("sig-clearBtn");
        var submitBtn = document.getElementById("sig-submitBtn");

        clearBtn.addEventListener("click", function (e) {
            clearCanvas();
            //sigText.innerHTML = "Data URL for your signature will go here!";
            sigImage.setAttribute("src", "");
        }, false);

        submitBtn.addEventListener("click", function (e) {
            var codigoBoleta = $("#codBoleta").val();
            if (codigoBoleta == "") {
                clearCanvas();
                alert('ERROR: No puede guardar una firma si no existe el Código de Boleta.');
            }
            else {
                var dataUrl = canvas.toDataURL();
                //sigText.innerHTML = dataUrl;
                //sigImage.setAttribute("src", dataUrl);
                $.ajax({
                    type: 'POST',
                    url: "/BoletaVisita/setFirma",
                    data: '{ "imageData" : "' + dataUrl + '", "boletaPago" : "' + codigoBoleta + '" }',
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    success: function (msg) {
                        alert('Firma Capturada con Éxito!');
                    }
                });
            }
        }, false);
    })();

    //manejar scroll
    function disableScrolling() {
        var x = window.scrollX;
        var y = window.scrollY;
        window.onscroll = function () { window.scrollTo(x, y); };
    }

    function enableScrolling() {
        window.onscroll = function () { };
    }

    //Manejar Boleta Visita Detalle (Tareas)
    function MostrarNuevaTarea() {
        if ($("#nitCliente").val() == "") {
            alert("Nit del Cliente no puede estar vacío");
            return;
        }
        if ($("#nombreCliente").val() == "") {
            alert("Nombre del Cliente no puede estar vacío");
            return;
        }
        if ($("#direccionCliente").val() == "") {
            alert("Direccion del Cliente no puede estar vacío");
            return;
        }
        if ($("#email").val() == "") {
            alert("E-mail del Cliente no puede estar vacío");
            return;
        } else {
            if (ValidateEmail($("#email").val()) == false) {
                alert("E-mail no es correcto, asegurese de anotar bien el correo electrónico");
                return;
            }
            }      

        if ($("#nitCliente").val() == "") {
            alert("Nit del Cliente no puede estar vacío");
            return;
        } else {
            if (nitIsValid($("#nitCliente").val()) == false) {
                alert("Nit incorrecto, asegurese de anotar bien el Nit de la SAT");
                return;
            }
        }

        //Guardo y traigo el codigo de boleta
        GuardarEncabezado();
     
    }


    function GuardarEncabezado() {          
        var data = $("#frmEncabezado").serialize();
        $.ajax({
            type: "POST",
            url: '/BoletaVisita/CreateBoletaEnc',            
            data: data,             
            success: function (boleta)
            {
                //alert('la boleta es:' + boleta);
                $("#codBoleta").val(boleta);
                $("#partialView-AddDetail").load('@(Url.Action("_CreateDetail", "BoletaVisita", null, Request.Url.Scheme))?codBoleta=' + boleta);                                  
                $("#firmaCliente").show();
                $("#partialView-AddDetail").show();
            }            
        });
       // console.log(data);
        
    }




      //funcion para validar correo electrónico
    function ValidateEmail(inputText) {    
        var filter = /^(([^<>()\[\]\\.,;:\s@@"]+(\.[^<>()\[\]\\.,;:\s@@"]+)*)|(".+"))@@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        if (!filter.test(inputText)) {        
            return false;
        }
        return true;
    }

    //validar nit guatemalteco
    function nitIsValid(nit) {
        if (!nit) {
            return true;
        }

        var nitRegExp = new RegExp('^[0-9]+(-?[0-9kK])?$');

        if (!nitRegExp.test(nit)) {
            return false;
        }

        nit = nit.replace(/-/, '');
        var lastChar = nit.length - 1;
        var number = nit.substring(0, lastChar);
        var expectedCheker = nit.substring(lastChar, lastChar + 1).toLowerCase();

        var factor = number.length + 1;
        var total = 0;

        for (var i = 0; i < number.length; i++) {
            var character = number.substring(i, i + 1);
            var digit = parseInt(character, 10);

            total += (digit * factor);
            factor = factor - 1;
        }

        var modulus = (11 - (total % 11)) % 11;
        var computedChecker = (modulus == 10 ? "k" : modulus.toString());

        return expectedCheker === computedChecker;
    }
</script>

<style>
    #sig-canvas {
        border: 2px dotted #CCCCCC;
        border-radius: 15px;
        cursor: crosshair;
    }
</style>
